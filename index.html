<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Cabinet24</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }

    .container {
      padding: 16px;
    }

    h1, h2 {
      margin: 0 0 12px 0;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .muted {
      color: #777;
      font-size: 14px;
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      background: #2a8cff;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    button.secondary {
      background: #ddd;
      color: #000;
    }

    .object-item {
      cursor: pointer;
    }

    .doc {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
<div class="container" id="app"></div>

<script>
/* =====================================================
   CONFIG
===================================================== */
const API_URL = '–í–°–¢–ê–í–¨_URL_BACKEND'; // –±–µ–∑ ?action

/* =====================================================
   INIT TELEGRAM
===================================================== */
const tg = window.Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe?.user;
const app = document.getElementById('app');

if (!user) {
  app.innerText = '–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram';
} else {
  loadObjects();
}

/* =====================================================
   STATE
===================================================== */
let allObjects = [];
let currentObject = null;

/* =====================================================
   API HELPERS
===================================================== */
function apiGet(action, params = {}) {
  const query = new URLSearchParams({
    action,
    telegramId: user.id,
    ...params
  });
  return fetch(`${API_URL}?${query}`).then(r => r.json());
}

function apiPost(data) {
  return fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  }).then(r => r.json());
}

/* =====================================================
   MAIN SCREEN
===================================================== */
function loadObjects() {
  apiGet('getObjects').then(data => {
    allObjects = data;
    renderMain();
  });
}

function renderMain() {
  app.innerHTML = `
    <h1>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${user.first_name || ''}</h1>

    <input id="search" placeholder="–ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞">

    <button onclick="renderAddObject()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</button>

    <div id="objects"></div>
  `;

  document.getElementById('search').oninput = e => {
    renderObjectList(e.target.value);
  };

  renderObjectList('');
}

function renderObjectList(query) {
  const list = document.getElementById('objects');
  list.innerHTML = '';

  allObjects
    .filter(o => o.name.toLowerCase().includes(query.toLowerCase()))
    .forEach(o => {
      const el = document.createElement('div');
      el.className = 'card object-item';
      el.innerHTML = `
        <h2>${o.name}</h2>
        <div class="muted">–û—Å—Ç–∞—Ç–æ–∫: ${o.balance}</div>
      `;
      el.onclick = () => renderObject(o);
      list.appendChild(el);
    });
}

/* =====================================================
   ADD OBJECT
===================================================== */
function renderAddObject() {
  app.innerHTML = `
    <h2>–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç</h2>

    <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞">
    <input id="price" type="number" placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å">
    <input id="note" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">

    <button onclick="saveObject()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="secondary" onclick="renderMain()">–ù–∞–∑–∞–¥</button>
  `;
}

function saveObject() {
  const name = document.getElementById('name').value;
  const price = document.getElementById('price').value;
  const note = document.getElementById('note').value;

  apiPost({
    action: 'addObject',
    telegramId: user.id,
    name,
    price,
    note
  }).then(() => loadObjects());
}

/* =====================================================
   OBJECT SCREEN
===================================================== */
function renderObject(obj) {
  currentObject = obj;

  app.innerHTML = `
    <h2>${obj.name}</h2>

    <div class="card">
      <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${obj.price}</div>
      <div>–û–ø–ª–∞—á–µ–Ω–æ: ${obj.payments_count} / ${obj.payments_sum}</div>
      <div><b>–û—Å—Ç–∞—Ç–æ–∫: ${obj.balance}</b></div>
    </div>

    <div class="card">
      <h3>–£—Å–ª—É–≥–∏</h3>
      ${obj.services.map(s => `
        <div class="muted">${s.name} ‚Äî ${s.status}</div>
      `).join('')}
    </div>

    <button onclick="renderDocuments()">üìé –î–æ–∫—É–º–µ–Ω—Ç—ã</button>
    <button class="secondary" onclick="renderMain()">–ù–∞–∑–∞–¥</button>
  `;
}

/* =====================================================
   DOCUMENTS
===================================================== */
function renderDocuments() {
  apiGet('getDocuments', { objectId: currentObject.id }).then(docs => {
    app.innerHTML = `
      <h2>–î–æ–∫—É–º–µ–Ω—Ç—ã</h2>

      <div class="card">
        ${docs.map(d => `
          <div class="doc">
            <span>üìÑ ${d.name}</span>
            <a target="_blank"
               href="https://drive.google.com/uc?id=${d.file_id}">
               –°–∫–∞—á–∞—Ç—å
            </a>
          </div>
        `).join('')}
      </div>

      <input type="file" id="file">
      <button onclick="uploadDoc()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
      <button class="secondary" onclick="renderObject(currentObject)">–ù–∞–∑–∞–¥</button>
    `;
  });
}

function uploadDoc() {
  const file = document.getElementById('file').files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    apiPost({
      action: 'uploadDocument',
      objectId: currentObject.id,
      fileName: file.name,
      mimeType: file.type,
      file: reader.result.split(',')[1]
    }).then(() => renderDocuments());
  };
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
